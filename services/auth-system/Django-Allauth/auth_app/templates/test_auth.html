<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Django Auth Test (Sessions + JWT Compatible)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, button { margin: 5px 0; padding: 5px; width: 250px; }
  .section { margin-bottom: 30px; padding: 10px; border: 1px solid #ccc; }
  h2 { margin-top: 0; }
  pre { background: #f5f5f5; padding: 10px; white-space: pre-wrap; }
  .success { color: green; }
  .error { color: red; }
</style>
</head>
<body>

<h1>Django Auth Test (Sessions + JWT Compatible)</h1>

<!-- ---------------- SESSION LOGIN ---------------- -->
<div class="section">
  <h2>Session Login</h2>
  <input id="login-username" placeholder="Username"><br>
  <input id="login-password" type="password" placeholder="Password"><br>
  <button onclick="loginSession()">Login (Session)</button>
  <pre id="login-result"></pre>
</div>


<!-- ---------------- RESEND ACTIVATION EMAIL ---------------- -->
<div class="section">
  <h2>Resend Activation Email</h2>
  <input id="resend-email" placeholder="Email"><br>
  <button onclick="resendActivation()">Resend Activation</button>
  <pre id="resend-result"></pre>
</div>

<!-- ---------------- SIGNUP ---------------- -->
<div class="section">
  <h2>Signup</h2>
  <input id="signup-username" placeholder="Username"><br>
  <input id="signup-email" placeholder="Email"><br>
  <input id="signup-password" type="password" placeholder="Password"><br>
  <input id="signup-password2" type="password" placeholder="Confirm Password"><br>
  <button onclick="signupSession()">Signup</button>
  <pre id="signup-result"></pre>
</div>

<!-- ---------------- FORGOT PASSWORD ---------------- -->
<div class="section">
  <h2>Forgot Password</h2>
  <input id="forgot-email" placeholder="Email"><br>
  <button onclick="forgotPassword()">Send Reset Email</button>
  <pre id="forgot-result"></pre>
</div>

<!-- ---------------- PROFILE (SESSION) ---------------- -->
<div class="section">
  <h2>Profile (Session)</h2>
  <button onclick="updateProfile()">Get Profile</button>
  <pre id="profile-result"></pre>
</div>

<!-- ---------------- SESSION STATUS & LOGOUT ---------------- -->
<div class="section">
  <h2>Session Status & Logout</h2>
  <strong>Session:</strong> <span id="session-status">checking...</span><br><br>
  <button id="check-session-btn">Check Session</button>
  <button id="logout-btn">Logout</button>
  <pre id="logout-result"></pre>
</div>

<!-- ---------------- GOOGLE LOGIN ---------------- -->
<div class="section">
  <h2>Sign in with Google</h2>
  <button onclick="googleLogin()" style="background:#4285F4;color:white;border:none;padding:10px 20px;font-size:16px;cursor:pointer;">
    Sign in with Google
  </button>
</div>


<script>
const API_URL = '/api';
let jwtAccess = null;
let jwtRefresh = null;

// ------------------- FETCH UTILS -------------------
async function fetchJSON(url, options = {}, useJWT = false) {
  options.credentials = 'include';
  options.headers = options.headers || {};
  if (useJWT && jwtAccess) options.headers['Authorization'] = `Bearer ${jwtAccess}`;
  if (['POST','PUT','PATCH','DELETE'].includes(options.method?.toUpperCase())) {
    options.headers['X-CSRFToken'] = getCSRFToken();
    options.headers['Content-Type'] = 'application/json';
    if (options.body && typeof options.body === 'object') options.body = JSON.stringify(options.body);
  }
  const res = await fetch(url, options);
  let data;
  try { data = await res.json(); } catch { data = await res.text(); }
  return { ok: res.ok, status: res.status, data };
}

function getCSRFToken() {
  const name = 'csrftoken';
  for (const c of document.cookie.split(';')) {
    const trimmed = c.trim();
    if (trimmed.startsWith(name + '=')) return decodeURIComponent(trimmed.split('=')[1]);
  }
  return '';
}

function showResult(elId, res) {
  const el = document.getElementById(elId);
  el.textContent = typeof res === 'string' ? res : JSON.stringify(res, null, 2);
  el.className = (res && res.success) ? 'success' : 'error';
}

// ------------------- SESSION MODE -------------------
async function loginSession() {
  const res = await fetchJSON(`${API_URL}/login/`, {
    method: 'POST',
    body: {
      username: document.getElementById('login-username').value,
      password: document.getElementById('login-password').value
    }
  });
  showResult('login-result', res.data);
  await checkSession();
}

async function signupSession() {
  const res = await fetchJSON(`${API_URL}/signup/`, {
    method: 'POST',
    body: {
      username: document.getElementById('signup-username').value,
      email: document.getElementById('signup-email').value,
      password1: document.getElementById('signup-password').value,
      password2: document.getElementById('signup-password2').value
    }
  });
  showResult('signup-result', res.data);
}


async function forgotPassword() {
  const res = await fetchJSON(`${API_URL}/reset-password/`, { // corrected endpoint
    method: 'POST',
    body: { email: document.getElementById('forgot-email').value }
  });
  showResult('forgot-result', res.data);
}

async function checkSession() {
  const res = await fetchJSON(`${API_URL}/session/`);
  const isActive = res.data?.is_authenticated ?? false;
  document.getElementById('session-status').textContent =
    isActive ? `active â€” ${res.data?.user?.username}` : 'inactive';
  document.getElementById('session-status').style.color = isActive ? 'green' : 'red';
  updateProfile();
}

async function updateProfile() {
  const res = await fetchJSON(`${API_URL}/profile/`);
  showResult('profile-result', res.data);
}

async function logout() {
  const res = await fetchJSON(`${API_URL}/logout/`, { method: 'POST' });
  showResult('logout-result', res.data);
  checkSession();
}


// ------------------- GOOGLE LOGIN -------------------
function googleLogin() {
  // Redirects browser to the social login API which immediately redirects to Google OAuth
  window.location.href = `${API_URL}/social-login/google/`;
}



<!-- ---------------- RESEND ACTIVATION EMAIL ---------------- -->

async function resendActivation() {
  const email = document.getElementById('resend-email').value;
  if (!email) return alert("Please enter an email.");

  const res = await fetch('/api/resend-activation/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    credentials: 'include',
    body: JSON.stringify({ email })
  });

  let data;
  try { data = await res.json(); } catch { data = await res.text(); }
  const el = document.getElementById('resend-result');
  el.textContent = JSON.stringify(data, null, 2);
  el.className = (data.success) ? 'success' : 'error';
}


// ------------------- INIT -------------------
document.getElementById('check-session-btn').addEventListener('click', checkSession);
document.getElementById('logout-btn').addEventListener('click', logout);
checkSession();
</script>

</body>
</html>
